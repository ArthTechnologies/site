<script>
  import RSS from "$lib/components/ui/RSS.svelte";
  import Email from "$lib/components/ui/Email.svelte";
  import { browser } from "$app/environment";

  //get the top 10 posts
  let hits = [];
  let platforms = [];
  let res = {};
  let x1 = [
    0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160,
    170, 180, 190, 200, 210, 220, 230, 240, 250, 260, 270, 280, 290, 300,
  ];
  let y1 = [];
  let points = "";
  let linux;
  let windows;
  let macos;
  let android;
  let ios;
  let unknown;

  let languages = [];
  let promise;

  let getStartedButtonClicks;
  if (browser) {
    promise = fetch("https://backend.arthmc.xyz/analytics")
      .then((response) => response.json())
      .then((json) => {
        res = json;
        console.log(json);
        hits = json.hits;
        platforms = json.devices;
        for (let i = 0; i < Object.keys(json.languages).length; i++) {
          let lang = {
            name: Object.keys(json.languages)[i],
            hits: json.languages[Object.keys(json.languages)[i]],
          };
          console.log(lang);
          languages.push(lang);
        }

        for (let i = res.day - 30; i <= res.day; i++) {
          if (res.days[i] == undefined) {
            y1.push(100);
          } else {
            y1.push(100 - (100 / res.max) * res.days[i]);
          }
        }
        for (let i = 0; i <= 30; i++) {
          points += `${x1[i]},${y1[i]} `;
        }
        linux = res.devices.linux;
        windows = res.devices.windows;
        macos = res.devices.macintosh;
        android = res.devices.android;
        ios = res.devices.iOS;
        unknown = res.devices.unknown;

        getStartedButtonClicks = res.getStartedButtonClicks;
      });
  }
</script>

<div class="flex items-center flex-col">
  <p class="text-lg font-bold my-3 ml-8">Hits in the last 30 days</p>
  <div class="bg-base-200 rounded-xl shadow mb-5">
    <svg width="300" height="100">
      <!-- x axis -->
      <line x1="0" x2="300" y1="100" y2="100" />
      <g class="x" transform="translate(0,120)">
        <text x="0">30</text>
        <text x="60">24</text>
        <text x="120">18</text>
        <text x="180">12</text>
        <text x="240">6</text>
        <text x="300">Today</text>
      </g>

      <!-- y axis -->
      <line x1="0" x2="0" y1="0" y2="100" />
      <g class="y" transform="translate(-10,0)">
        <text y="100">0</text>
        <text y="50">{res.max / 2}</text>
        <text y="0">{res.max}</text>
      </g>

      <!-- data -->
      <polyline
        style="stroke: #00a4cd; stroke-width: 2"
        points="
      {points}
    "
      />
    </svg>
  </div>
</div>

<div class="flex flex-col items-center pb-36">
  <p class="text-lg font-bold mt-3 ml-8 mb-3">Hits by platform</p>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">Windows: {windows}</p>
    <p class="text-center">{Math.round((windows / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">Linux: {linux}</p>
    <p class="text-center">{Math.round((linux / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">Mac: {macos}</p>
    <p class="text-center">{Math.round((macos / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">iOS: {ios}</p>
    <p class="text-center">{Math.round((ios / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">Android: {android}</p>
    <p class="text-center">{Math.round((android / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">Unknown: {unknown}</p>
    <p class="text-center">{Math.round((unknown / res.hits) * 100)}%</p>
  </div>
  <p class="text-lg font-bold mt-3 ml-8 mb-3">Hits by language</p>
  <div class="grid grid-cols-4 grid-flow-col gap-4 w-[24.75rem]">
    {#await promise then}
      {#each languages as language, index}
        <div
          class="bg-base-200 h-16 rounded-xl shadow p-2 pl-2.5 justify-between mb-3 text-sm"
        >
          <p class="mt-1">
            <span class="font-bold uppercase">{language.name}:</span>
            {Math.round((language.hits / res.initial) * 100)}%
          </p>
          <p>{language.hits} Hits</p>
        </div>
      {/each}
    {/await}
  </div>

  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3 mt-8"
  >
    <p class="text-left">
      "Get Started" Button Clicks: {getStartedButtonClicks}
    </p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3 mt-8"
  >
    <p class="text-left">
      First Time Visitors: {res.initial}
    </p>
    <p class="text-center">{Math.round((res.initial / res.hits) * 100)}%</p>
  </div>
  <div
    class="bg-base-200 w-[24.75rem] rounded-xl shadow p-5 flex justify-between mb-3"
  >
    <p class="text-left">
      Returning Visitors: {res.returning}
    </p>
    <p class="text-center">{Math.round((res.returning / res.hits) * 100)}%</p>
  </div>
</div>

<style>
  svg {
    overflow: visible;
    margin: 3em;
  }

  line,
  polyline {
    fill: none;
    stroke: black;
  }

  .x text {
    text-anchor: middle;
  }

  .y text {
    text-anchor: end;
    dominant-baseline: middle;
  }
</style>
